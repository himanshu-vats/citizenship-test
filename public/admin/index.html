<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <style>
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      #custom-login {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      #custom-login button {
        padding: 16px 32px;
        font-size: 18px;
        background: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600;
        color: #667eea;
      }
      #custom-login button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    </style>
  </head>
  <body>
    <!-- Custom login screen (shown before auth) -->
    <div id="custom-login" style="display: none;">
      <button onclick="window.location.href='/api/auth?provider=github&scope=repo,user'">
        üîê Login with GitHub
      </button>
    </div>

    <!-- CMS container (shown after auth) -->
    <div id="cms-root"></div>

    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>

    <!-- Cookie-based OAuth Handler -->
    <script>
      console.log("=== CMS Admin Page Loaded ===");

      // Check if we're returning from OAuth
      const urlParams = new URLSearchParams(window.location.search);
      const authSuccess = urlParams.get('auth');

      if (authSuccess === 'success') {
        console.log('[Admin] üîÑ OAuth successful, retrieving token from cookie...');

        // Fetch token from secure cookie
        fetch('/api/get-token')
          .then(response => response.json())
          .then(data => {
            if (data.token) {
              console.log('[Admin] ‚úÖ Token retrieved! Storing in localStorage...');

              // Store token for CMS to use
              localStorage.setItem('netlify-cms-user', JSON.stringify({
                token: data.token,
                backendName: 'github'
              }));

              console.log('[Admin] üîÑ Reloading to initialize CMS...');

              // Remove auth query parameter and reload
              const newUrl = window.location.pathname;
              window.history.replaceState({}, document.title, newUrl);
              window.location.reload();
            } else {
              console.error('[Admin] ‚ùå No token in response');
            }
          })
          .catch(error => {
            console.error('[Admin] ‚ùå Error fetching token:', error);
            alert('Failed to retrieve authentication token. Please try again.');
            window.location.href = '/admin';
          });
      } else {
        // Check if user is already authenticated
        const existingAuth = localStorage.getItem('netlify-cms-user');

        if (!existingAuth) {
          console.log('[Admin] ‚ùå Not authenticated, showing login screen');
          document.getElementById('custom-login').style.display = 'flex';
          document.getElementById('cms-root').style.display = 'none';
        } else {
          console.log('[Admin] ‚úÖ Already authenticated, loading CMS');
          document.getElementById('custom-login').style.display = 'none';
        }
      }
    </script>
  </body>
</html>
