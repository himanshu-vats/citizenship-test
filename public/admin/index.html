<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <style>
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      #custom-login {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      #custom-login button {
        padding: 16px 32px;
        font-size: 18px;
        background: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600;
        color: #667eea;
      }
      #custom-login button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    </style>

    <!-- CRITICAL: Set this BEFORE loading CMS script -->
    <script>
      window.CMS_MANUAL_INIT = true;
      console.log('[Init] CMS_MANUAL_INIT set to true');
    </script>
  </head>
  <body>
    <!-- Custom login screen (shown before auth) -->
    <div id="custom-login" style="display: none;">
      <button onclick="window.location.href='/api/auth?provider=github&scope=repo,user'">
        üîê Login with GitHub
      </button>
    </div>

    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>

    <!-- Cookie-based OAuth Handler -->

    <script>
      console.log("=== CMS Admin Page Loaded ===");

      // Check if we're returning from OAuth
      const urlParams = new URLSearchParams(window.location.search);
      const authSuccess = urlParams.get('auth');

      if (authSuccess === 'success') {
        console.log('[Admin] üîÑ OAuth successful, retrieving token from cookie...');

        // Fetch token from secure cookie
        fetch('/api/get-token')
          .then(response => response.json())
          .then(data => {
            if (data.token) {
              console.log('[Admin] ‚úÖ Token retrieved! Storing in localStorage...');

              // Store token for CMS to use
              localStorage.setItem('netlify-cms-user', JSON.stringify({
                token: data.token,
                backendName: 'github'
              }));

              console.log('[Admin] üîÑ Reloading to initialize CMS...');

              // Remove auth query parameter and reload
              const newUrl = window.location.pathname;
              window.history.replaceState({}, document.title, newUrl);
              window.location.reload();
            } else {
              console.error('[Admin] ‚ùå No token in response');
            }
          })
          .catch(error => {
            console.error('[Admin] ‚ùå Error fetching token:', error);
            alert('Failed to retrieve authentication token. Please try again.');
            window.location.href = '/admin';
          });
      } else {
        // Check if user is already authenticated
        const existingAuth = localStorage.getItem('netlify-cms-user');

        if (!existingAuth) {
          console.log('[Admin] ‚ùå Not authenticated, showing login screen');
          document.getElementById('custom-login').style.display = 'flex';
          document.getElementById('cms-root').style.display = 'none';
        } else {
          console.log('[Admin] ‚úÖ Already authenticated, loading CMS');
          console.log('[Admin] Token data:', existingAuth);

          // Parse and verify token
          try {
            const authData = JSON.parse(existingAuth);
            console.log('[Admin] Parsed auth data:', {
              hasToken: !!authData.token,
              tokenPreview: authData.token ? authData.token.substring(0, 20) + '...' : 'none',
              backendName: authData.backendName
            });

            // Wait for CMS to be fully loaded, then initialize
            if (authData.token) {
              console.log('[Admin] üîß Waiting for CMS to load...');

              // Wait for CMS to be available
              const initCMS = () => {
                if (!window.CMS) {
                  console.log('[Admin] ‚è≥ CMS not loaded yet, waiting...');
                  setTimeout(initCMS, 100);
                  return;
                }

                console.log('[Admin] ‚úÖ CMS loaded, initializing...');

                // Use Decap CMS's GitHub backend with our token
                const CMSConfig = {
                  load_config_file: false,
                  backend: {
                    name: 'github',
                    repo: 'himanshu-vats/citizenship-test',
                    branch: 'main'
                  },
                  media_folder: 'public/images/blog',
                  public_folder: '/images/blog',
                  collections: [{
                    name: 'blog',
                    label: 'Blog Articles',
                    folder: 'content/blog',
                    create: true,
                    slug: '{{slug}}',
                    fields: [
                      { label: 'Title', name: 'title', widget: 'string', hint: 'Article headline' },
                      { label: 'Excerpt', name: 'excerpt', widget: 'text', hint: 'Short summary' },
                      { label: 'Category', name: 'category', widget: 'select', options: ['Getting Started', 'Process Guide', 'Study Tips', 'Civics Questions', 'Immigration Updates', 'Success Stories'], default: 'Process Guide' },
                      { label: 'Publish Date', name: 'date', widget: 'datetime', date_format: 'YYYY-MM-DD', time_format: false },
                      { label: 'Read Time', name: 'readTime', widget: 'string', hint: 'e.g., "5 min read"', default: '5 min read' },
                      { label: 'Meta Description', name: 'metaDescription', widget: 'text', hint: 'SEO description' },
                      { label: 'Body', name: 'body', widget: 'markdown' }
                    ]
                  }]
                };

                console.log('[Admin] üöÄ Calling CMS.init()...');
                try {
                  window.CMS.init({ config: CMSConfig });
                  console.log('[Admin] ‚úÖ CMS initialized successfully!');
                } catch (error) {
                  console.error('[Admin] ‚ùå CMS initialization error:', error);
                }
              };

              initCMS();
            }
          } catch (error) {
            console.error('[Admin] ‚ùå Error parsing auth data:', error);
          }

          document.getElementById('custom-login').style.display = 'none';
        }
      }
    </script>
  </body>
</html>
